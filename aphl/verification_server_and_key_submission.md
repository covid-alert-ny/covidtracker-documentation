# Verification Server and Key Submission Process

The following describes endpoints and their function to ensure the NYS Covid Tracking system is compatible with the APHL Exposure Notification Verification and Key Servers defined in https://developers.google.com/android/exposure-notifications/verification-system. The NYS Covid Tracking system will launch using NYS specific verification and key servers with the intent of migrating to the national APHL key server when ready. Ensuring that the NYS verification server, NYS key server, and NYS Mobile Exposure Notification App are compatible with the national verification and key servers will allow for a seamless transition.

The following Verification Flow Diagram can be used to help indicate which part of the process each step below is referring to.

![Verificatioon Flow Diagram](verification-certificate-hmac-flow-diagram.png)

## Definitions

* __Case Investigation Epidemiologist (EPI)__: A Case Investigation Epidemiologist is a public health official who coontacts a user upon a positive diagnosis. They may also be referred to as Contact Tracers.
* __Verification Code (VC)__: A verification code is an 8 digit number generated by a public health official and given to a user. This is the code that allows app users to beging the process of submitting their TEKs to the key server.
* __Temporary Exposure Key (TEK)__: A key that's randomly generated once every 24 hours. It remains on the device for up to 14 days. In the event that there's a positive diagnosis of COVID-19, and upon permission granted from the user, these keys are provided to the app.
* __Verification Server Metadata (VS-metadata)__: Metadata about the user that was entered by an EPI and submitted when requesting a verification code. It can include things such as symptom onset date, test date, and transmission risk.
* __User Metadata (U-metadata)__: Metadata about the user that was entered by the user. It can include things such as symptoom onseet date and test date.
* __Public Health Authority (PHA)__: NYS Department of Health

## Requesting Verification Codes

Diagram Steps (1), (2), and (3).

Verification codes are requested by an EPI when a user has tested positive for Covid-19. The EPI (or an automated SMS text message) will transmit the VC to the user.

<table>
<tr>
<td>Initiator</td>
<td>The EPI, using a PHA controlled website will send an HTTP request to the verification service.</td>
</tr>
<tr>
<td>Endpoint</td>
<td>POST to `/vc/generate`</td>
</tr>
<tr>
<td>Authn/Authz</td>
<td>Authorization Bearer JWT providing caller with ability to generate verification codes</td>
</tr>
<tr>
<td>Input</td>
<td>

    {
       "daysSinceOnset": # of days since symptom onset, optional,
       "testDate": "yyyy-mm-dd of test, optional"
    }

</td>
</tr>
</table>

#### Description

The handler will verify the authorization header and ensure the JWT has ability to generate verification codes. It will generate a verification token 8 digits long. One of those digits should be a configurable check value. It will also generate an expiry timestamp (UTC). The VC, expiry timestamp, and metadata object will be written to the `verification_codes` table. If the VC already exists in the table then the generation process will be repeated until a non-used VC is found.

The `verification_codes` table has a primary key / unique index on the VC value.

#### Response

<table>
<tr><th>Code</th><th>Data / Meaning</th></tr>
<tr>
<td>200</td>
<td>

    {
       "code": "8 character verification code, likely all numbers",
       "expiry": "UTC timestamp when this verification code will expire"
    }
</td>
</tr>
<tr>
<td>400</td>
<td>Bad request, indicating the metadata is not valid</td>
</tr>
<tr>
<td>401</td>
<td>Caller is not authorized to use this endpoint (the JWT was rejected)</td>
</tr>
<tr>
<td>500</td>
<td>Server error</td>
</tr>
</table>

__Open Question__: We should discuss whether the PHA will submit transmission risk overrides, or if we will use the App calculated transmission risks. If PHA provided, then they will be added to this input data object.

## Sending Verification Codes

Diagram Step (3) (alternative option)

The EPI can initiate a automated transfer of a VC to the user.

<table>
<tr>
<td>Initiator</td>
<td>The EPI, using a PHA controlled website will send an HTTP request to the verification service.</td>
</tr>
<tr>
<td>Endpoint</td>
<td>POST to `/vc/send/sms`</td>
</tr>
<tr>
<td>Authn/Authz</td>
<td>Authorization Bearer JWT providing caller with ability to send verification codes</td>
</tr>
<tr>
<td>Input</td>
<td>

    {
       "code": "8 digit verification code",
       "mobile": "User's mobile phone #"
    }

</td>
</tr>
</table>

#### Description

The handler will verify the authorization header and ensure the JWT has ability to send verification codes. It will verify the mobile phone number is a valid phone number (though no country code checks should be done). If the mobile # doesn't include a country code then it will assume the US country code. It will verify the VC check value, that the VC exists in table `verification_codes`, and that it hasn't expired. It will then pass the input body to an AWS message queue. Messages on that message queue will initiate a Lambda that is capable of sending SMS messages. The SMS message should include an App deep link that will open the App, start the verification code submission process, and fill in the VC.

The system __NEVER__ stores the mobile number.

#### Response

<table>
<tr><th>Code</th><th>Data / Meaning</th></tr>
<tr>
<td>200</td>
<td>Request to send SMS was submitted successfully</td>
</tr>
<tr>
<td>400</td>
<td>Bad request, indicating the code or mobile # is not valid</td>
</tr>
<tr>
<td>401</td>
<td>Caller is not authorized to use this endpoint (the JWT was rejected)</td>
</tr>
<tr>
<td>410</td>
<td>Code has expired</td>
</tr>
<tr>
<td>500</td>
<td>Server error</td>
</tr>
</table>

__Open Question__: To support people who don't want to give their mobile # should we also have an endpoint that can send an email?

## Verification Code Validation

Diagram steps (4) and (5).

The user enters their VC into the App.

<table>
<tr>
<td>Initiator</td>
<td>The user, upon receiving a VC from the EPI</td>
</tr>
<tr>
<td>Endpoint</td>
<td>POST to `/vc/validate`</td>
</tr>
<tr>
<td>Authn/Authz</td>
<td>TBD, though I'd like to use a JWT given to the user when they register in the system</td>
</tr>
<tr>
<td>Input</td>
<td>

    {
       "code": "8 digit verification code"
    }

</td>
</tr>
</table>

#### Description

The user submits their VC to the verification server for validation. The server will 

1. Validate the VC is the correct length and confirm check value
2. Check rate limits on the user - only allowed to submit 1 VC per second. This is done by storing on the user record the last time they tried to validate a VC.
3. Check whether the VC is a valid code and hasn't expired. This is done by attempting to delete the VC from the `verification_codes` table. If the record can be deleted then it existed and was a valid VC.
4. Generate a new JWT with a TTL of 24 hours. It does not need to contain any claims, nor does it need to identify the user at all.
5. Return the JWT to the caller.

#### Response

<table>
<tr><th>Code</th><th>Data / Meaning</th></tr>
<tr>
<td>200</td>
<td>

    {
       "token": "valid JWT with 24hr expiry",
    }
</td>
</tr>
<tr>
<td>401</td>
<td>Caller is not authorized to use this endpoint</td>
</tr>
<tr>
<td>404</td>
<td>Code is not valid or does not exist</td>
</tr>
<tr>
<tr>
<td>410</td>
<td>Code has expired</td>
</tr>
<tr>
</tr>
<tr>
<td>429</td>
<td>To many requests from the user, ie rate limit exceeded</td>
</tr>
<tr>
<td>500</td>
<td>Server error</td>
</tr>
</table>

__Open Question__: Do we want to include a set of claims in the returned JWT? Technically this JWT is only used to verify the user was able to submit a valid VC and that they did so within some defined duration. 


## Request Signiture of TEKs and Metadata

## Submitting TEKs and Metadata
